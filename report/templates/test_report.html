{% extends '_layouts/base.html' %}

{% block title %} Test Report for Build {{ build_info.build_name}}-{{build_info.build_no}}  {% endblock %}

{% block headline %}<h1>Test Report for Build {{ build_info.build_name}}-{{build_info.build_no}}</h1>{% endblock %}

{% block content %}

<div align="left">
<table>
<tr>
{% for build_no in build_info.build_numbers %}
    {% ifequal build_no build_info.build_no %}
        <td>{{ build_no }} </td>
    {% else %}
        <td><a href="/report/test-report/?build_name={{ build_info.build_name}}&&build_no={{ build_no }}">{{ build_no}} </a></td>
    {% endifequal %}
    &nbsp;&nbsp;
{% endfor %}

</tr>
</table>
<hr/>
<h2>Build Summary</h2>
<table border=2>
    <tr>
        <th align="left">Build Name </th>
        <td>{{ build_info.build_name}} </td>
    <tr/>
    <tr>
        <th align="left">Build Number </th>
        <td>{{ build_info.build_no}} </td>
    <tr/>
    <tr>
        <th align="left">Build Config </th>
        <td><a href="{{ build_info.build_config_url }}">{{ build_info.build_config_name }} </a></td>
    <tr/>
    <tr>
        <th align="left">Android Version </th>
        <td>{{ build_info.android_version }}</td>
    <tr/>
    <tr>
        <th align="left">Kernel Version </th>
        {% ifequal build_info.kernel_url '--' %}
        <td>{{ build_info.kernel_version }}</td>
        {% else %}
        <td> <a href="{{ build_info.kernel_url }}">{{ build_info.kernel_version }}</a></td>
        {% endifequal %}
    <tr/>
    <tr>
        <th align="left">Toolchain</th>
        <td align="left">{{ build_info.toolchain_info}}</td>
    <tr/>
    <tr>
        <th align="left">Firmware Info</th>
        {% ifequal build_info.firmware_url '--' %}
        <td>{{ build_info.firmware_version }}</td>
        {% else %}
        <td> <a href="{{ build_info.firmware_url }}">{{ build_info.firmware_version }}</a></td>
        {% endifequal %}
    <tr/>
    <tr>
        <th align="left">Images</th>
        <td align="left"><a href="{{ build_info.images_url }}">{{ build_info.images_url }}</a></td>
    <tr/>
    <tr>
        <th align="left">Cached In Base</th>
        <td align="left">
        {% if build_info.cached_in_base %}
            <button name="cache_to_base" onclick="this.disabled=true; window.location='/report/test-report/?build_name={{ build_info.build_name }}&build_no={{ build_info.build_no }}&cache_to_base=false'">
                Remove From Base
            </button>
        {% else %}
            <button name="cache_to_base" onclick="this.disabled=true; window.location='/report/test-report/?build_name={{ build_info.build_name }}&build_no={{ build_info.build_no }}&cache_to_base=true'">
                Cache Into Base
            </button>
        {% endif %}
        </td>
    <tr/>
</table>
<hr/>
{% if jobs_failed %}
<form action="/report/resubmit-job/" method="post">
<table border="2">
<tr>
    <th>Job Name</th>
    <th>Job Ids</th>
    <th>Resubmit latest</th>
    <th>bug link</th>
</tr>
{% for job in jobs_failed %}
<tr>
    <td>{{ job.name }}</td>
    <td>
        {% for id_status in job.id_status_list %}
        <a href="{{ lava_server_job_prefix }}/{{ id_status.0 }}"> {{ id_status.0 }}</a>: {{ id_status.1 }} <br>
        {% endfor %}
    </td>
    <td>
        {% with job.id_status_list|first as first_id_status %}
            {% if first_id_status.1 == 'Submitted' or  first_id_status.1 == 'Running' %}
            <button name="resubmit_latest" disabled="true" onclick="this.disabled=true; window.location='/report/resubmit-job/?build_name={{ build_info.build_name }}&&job_id={% with job.id_status_list|first as first_id_status %}{{ first_id_status.0 }}{% endwith %}'">
                Resubmit {% with job.id_status_list|first as first_id_status %}{{ first_id_status.0 }}{% endwith %}
            </button>
            <input type="checkbox" name="job_ids" value="{% with job.id_status_list|first as first_id_status %}{{ first_id_status.0 }}{% endwith %}" selected="false" disabled="false"/>
            {% else %}
            <button name="resubmit_latest" onclick="this.disabled=true; window.location='/report/resubmit-job/?build_name={{ build_info.build_name }}&&job_id={% with job.id_status_list|first as first_id_status %}{{ first_id_status.0 }}{% endwith %}'">
                Resubmit {% with job.id_status_list|first as first_id_status %}{{ first_id_status.0 }}{% endwith %}
            </button>
            <input type="checkbox" name="job_ids" value="{% with job.id_status_list|first as first_id_status %}{{ first_id_status.0 }}{% endwith %}" checked="true"/>

            {% endif %}
        {% endwith %}
    </td>
    <td>
        <a href="https://bugs.linaro.org/enter_bug.cgi?product=Linaro%20Android">Report Android Bug</a><br/>
        <a href="https://bugs.linaro.org/enter_bug.cgi?product=LAVA%20Framework">Report LAVA Bug</a><br/>
    </td>
</tr>
{% endfor %}
</table>
{% csrf_token %}
<input type="hidden" name="build_name" value="{{ build_info.build_name }}"/>
<input type="submit" value="Resubmit All Possible Failed Jobs"/>
&nbsp;&nbsp;<a href="/report/submit-jobs/?build_name={{ build_info.build_name }}"> Job Submission </a>
</form>
<hr/>
{% endif %}

<h2>Basic Weekly</h2>
{% if basic_optee_weekly_res %}
<table border="2">
<tr>
    <th rowspan=2>Index</th>
    <th rowspan=2>Job Name</th>
    <th rowspan=2>Test Name</th>
    <th colspan=3>Base({{ build_info.base_build_no }})</th>
    <th colspan=5>Current Build</th>
    <th rowspan=2 >Bugs</th>
    <th rowspan=2 >Operations</th>
</tr>
<tr>
    <th>Pass</th>
    <th>Fail</th>
    <th>Total</th>
    <th>Pass</th>
    <th>Fail</th>
    <th>Skip</th>
    <th>Total</th>
    <th>PassRate</th>
</tr>
{% for test_info in basic_optee_weekly_res %}
<tr>
    <td> {{ forloop.counter }}</td>
    {% if test_info.job_id %}
    <td> <a href="{{ lava_server_job_prefix }}/{{ test_info.job_id }}">{{ test_info.job_name }}</a></td>
    {% else %}
    <td> {{ test_info.job_name }}</td>
    {% endif %}
    <td align='left'> {{ test_info.test_suite }}</td>
    {% with test_info.base as base %}
    {% if base %}
    <td align='right'> {{ base.number_pass }}</td>
    <td align='right'> {{ base.number_fail }}</td>
    <td align='right'> {{ base.number_total }}</td>
    {% else %}
    <td align='right'> -- </td>
    <td align='right'> -- </td>
    <td align='right'> -- </td>
    {% endif %}
    {% endwith %}
    <td align='right'> {{ test_info.number_pass }}</td>
    {% ifequal test_info.number_fail 0 %}
    <td align='right'> {{ test_info.number_fail }}</td>
    {% else %}
    <td align='right' style="background-color:red" > {{ test_info.number_fail }}</td>
    {% endifequal %}
    <td align='right'> {{ test_info.number_skip }}</td>
    <td align='right'> {{ test_info.number_total }}</td>
    {% if test_info.number_passrate == 0 %}
    <td align='right' style="background-color:red" > {{ test_info.number_passrate|floatformat:2 }}</td>
    {% elif test_info.number_passrate == 100 %}
    <td align='right' style="background-color:green" > {{ test_info.number_passrate|floatformat:2 }}</td>
    {% else  %}
    <td align='right'  > {{ test_info.number_passrate|floatformat:2 }}</td>
    {% endif %}
    <td align='left'>
        {% with test_info.bugs as bugs %}
        {% for bug in bugs %}
            {% if not bug.build_no or bug.build_no == build_info.build_no %}
            <a target='_blank' href="{{ bug.link }}">{{ bug.bug_id }} </a><br/>
             {% endif %}
        {% endfor%}
        {% endwith%}
    </td>
    <td align='left'>
        {% ifnotequal test_info.number_passrate 100 %}
        <a target='_blank' href="/report/add-bug/?build_name={{ build_info.build_name }}&plan_suite={{ test_info.test_suite }}&&module_testcase={{ test_info.test_suite }}">Add Bug</a><br/>
        <a target='_blank' href="{{ build_info.new_bug_url_prefix }}{{ test_info.test_suite }}">Report Android Bug</a>&nbsp;
        <!--
        <a target='_blank' href="https://bugs.linaro.org/enter_bug.cgi?product=LAVA%20Framework">Report LAVA Bug</a>&nbsp;
        -->
        {% endifnotequal %}
    </td>
</tr>
{% endfor %}
</table>
{% else %}
No result for basic test, or optee test, or weekly test jobs
{% endif %}
<hr/>


<h2>Benchmarks</h2>
{% if benchmarks_res %}
<table border="2">
<tr>
    <th>Index</th>
    <th>Benchmarks</th>
    <th>Test Suite</th>
    <th>Test Cases</th>
    <th>Unit</th>
    <th>Base({{ build_info.base_build_no }})</th>
    <th>Current</th>
    <th>Difference(%)</th>
    <th>Bugs</th>
    <th>Operations</th>
</tr>
{% for test_info in benchmarks_res %}
<tr>
    <td> {{ forloop.counter }}</td>
    {% if test_info.job_id %}
    <td> <a href="{{ lava_server_job_prefix }}/{{ test_info.job_id }}">{{ test_info.job_name }}</a></td>
    {% else %}
    <td> {{ test_info.job_name }}</td>
    {% endif %}
    <td> {{ test_info.test_suite }}</td>
    <td> {{ test_info.test_case }}</td>
    <td> {{ test_info.unit }}</td>
    {% with test_info.base as base %}
    {% if base %}
    <td align='right'> {{ base.measurement }}</td>
    {% else %}
    <td align='right'> -- </td>
    {% endif %}
    {% endwith %}
    <td align='right'> {{ test_info.measurement }}</td>
    {% if test_info.difference >= 50 %}
    <td align='right' style="background-color:green" > {{ test_info.difference|floatformat:2 }}</td>
    {% elif test_info.difference <= -50 %}
    <td align='right' style="background-color:red" > {{ test_info.difference|floatformat:2 }}</td>
    {% else  %}
    <td align='right'> {{ test_info.difference |floatformat:2 }}</td>
    {% endif %}
    <td align='left'>
        {% with test_info.bugs as bugs %}
        {% for bug in bugs %}
            {% if not bug.build_no or bug.build_no == build_info.build_no %}
            <a target='_blank' href="{{ bug.link }}">{{ bug.bug_id }} </a><br/>
            {% endif %}
        {% endfor%}
        {% endwith%}
    </td>
    <td align='left'>
        {% if test_info.difference <= -50 %}
        <a target='_blank' href="/report/add-bug/?build_name={{ build_info.build_name }}&plan_suite={{ test_info.test_suite }}&&module_testcase={{ test_info.test_case }}">Add Bug</a><br/>
        <a target='_blank' href="{{ build_info.new_bug_url_prefix }}{{ test_info.test_case }}">Report Android Bug</a>&nbsp;
        <!--
        <a target='_blank' href="https://bugs.linaro.org/enter_bug.cgi?product=LAVA%20Framework">Report LAVA Bug</a>&nbsp;
        -->
        {% endif %}
    </td>
</tr>
{% endfor %}
</table>
{% else %}
No result for benchmark test jobs.
{% endif %}
<hr/>


<h2>CTS</h2>
{% if cts_res %}
Only failures in the focused1 and focused2 test plans, and zero pass rate modules will be focused.
<table border="2">
<tr>
    <th rowspan=2>Index</th>
    <th rowspan=2>Plan</th>
    <th rowspan=2>Module</th>
    <th colspan=4>Base({{ build_info.base_build_no }})</th>
    <th colspan=4>Current</th>
    <th rowspan=2>Bugs</th>
    <th rowspan=2>Comments</th>
    <th rowspan=2>Operations</th>
</tr>

<tr>
    <th>Pass</th>
    <th>Fail</th>
    <th>Total</th>
    <th>Pass Rate</th>
    <th>Pass</th>
    <th>Fail</th>
    <th>Total</th>
    <th>Pass Rate</th>
</tr>
{% for test_info in cts_res %}
<tr>
    <td> {{ forloop.counter }}</td>
    {% if test_info.job_id %}
    <td> <a href="{{ lava_server_job_prefix }}/{{ test_info.job_id }}">{{ test_info.job_name }}</a></td>
    {% else %}
    <td> {{ test_info.job_name }}</td>
    {% endif %}
    <td align='left'> {{ test_info.module_name }}</td>
    {% with test_info.base as base %}
    {% if base %}
    <td align='right'> {{ base.number_pass }}</td>
    <td align='right'> {{ base.number_fail }}</td>
    <td align='right'> {{ base.number_total }}</td>
    <td align='right'> {{ base.number_passrate|floatformat:2 }}</td>
    {% else %}
    <td align='right'> -- </td>
    <td align='right'> -- </td>
    <td align='right'> -- </td>
    <td align='right'> -- </td>
    {% endif %}
    {% if test_info.number_pass|add:0 > base.number_pass|add:0 %}
    <!--
    <td align='right' style="background-color:green" > {{ test_info.number_pass }}</td>
    -->
    <td align='right'> {{ test_info.number_pass }}</td>
    {% elif test_info.number_pass|add:0 < base.number_pass|add:0  %}
    <!--
    <td align='right' style="background-color:yellow" > {{ test_info.number_pass }}</td>
    -->
    <td align='right'> {{ test_info.number_pass }}</td>
    {% else  %}
    <td align='right'> {{ test_info.number_pass }}</td>
    {% endif %}
    {% endwith %}
    <td align='right'> {{ test_info.number_fail }}</td>
    <td align='right'> {{ test_info.number_total }}</td>
    {% if test_info.number_passrate == 0 %}
    <td align='right' style="background-color:red" > {{ test_info.number_passrate|floatformat:2 }}</td>
    {% elif test_info.number_passrate == 100 %}
    <td align='right' style="background-color:green" > {{ test_info.number_passrate|floatformat:2 }}</td>
    {% else  %}
    <td align='right'  > {{ test_info.number_passrate|floatformat:2 }}</td>
    {% endif %}
    <td align='left'>
        {% with test_info.bugs as bugs %}
        {% for bug in bugs %}
            {% if not bug.build_no or bug.build_no == build_info.build_no %}
            <a target='_blank' href="{{ bug.link }}">{{ bug.bug_id }} </a><br/>
            {% endif %}
        {% endfor%}
        {% endwith%}
    </td>
    <td>
        <ul>
        {% with test_info.comments as comments %}
        {% for comment in comments %}
            {% if not comment.build_no or comment.build_no == build_info.build_no %}
            <li>{{ comment.comment }}</li>
            {% endif %}
        {% endfor %}
        {% endwith %}
        </ul>
        {% ifnotequal test_info.number_passrate 100 %}
        <a target='_blank' href="/report/add-comment/?build_name={{ build_info.build_name }}&build_no={{ build_info.build_no }}&plan_suite={{ test_info.job_name }}&&module_testcase={{ test_info.module_name }}">Add Comment</a><br/>
        {% endifnotequal %}
    </td>
    <td align='left'>
        {% ifnotequal test_info.number_passrate 100 %}
        <a target='_blank' href="/report/add-bug/?build_name={{ build_info.build_name }}&build_no={{ build_info.build_no }}&plan_suite={{ test_info.job_name }}&&module_testcase={{ test_info.module_name }}">Add Bug</a><br/>
        <a target='_blank' href="{{ build_info.new_bug_url_prefix }}{{ test_info.module_name }}">Report Android Bug</a>&nbsp;
        <!--
        <a target='_blank' href="https://bugs.linaro.org/enter_bug.cgi?product=LAVA%20Framework">Report LAVA Bug</a>&nbsp;
        -->
        {% endifnotequal %}
    </td>
</tr>
{% endfor %}
</table>
{% else %}
No result for cts test jobs.
{% endif %}
<hr/>
<h2>VTS</h2>
{% if vts_res %}
<table border="2">
<tr>
    <th rowspan=2>Index</th>
    <th rowspan=2>Plan</th>
    <th colspan=4>Base({{ build_info.base_build_no }})</th>
    <th colspan=4>Current</th>
    <th rowspan=2>Current Failed Test Cases</th>
    <th rowspan=2>Bugs</th>
    <th rowspan=2>Operations</th>
</tr>
<tr>
    <th>Pass</th>
    <th>Fail</th>
    <th>Total</th>
    <th>Pass Rate</th>
    <th>Pass</th>
    <th>Fail</th>
    <th>Total</th>
    <th>Pass Rate</th>
</tr>
{% for test_info in vts_res %}
<tr>
    <td>{{ forloop.counter }}</a></td>
    {% if test_info.job_id %}
    <td> <a href="{{ lava_server_job_prefix }}/{{ test_info.job_id }}">{{ test_info.job_name }}</a></td>
    {% else %}
    <td> {{ test_info.job_name }}</td>
    {% endif %}
    {% with test_info.base as base %}
    {% if base %}
    <td align='right'> {{ base.number_pass }}</td>
    <td align='right'> {{ base.number_fail }}</td>
    <td align='right'> {{ base.number_total }}</td>
    <td align='right'> {{ base.number_passrate|floatformat:2 }}</td>
    {% else %}
    <td align='right'> -- </td>
    <td align='right'> -- </td>
    <td align='right'> -- </td>
    <td align='right'> -- </td>
    {% endif %}
    {% endwith %}
    <td align='right'> {{ test_info.number_pass }}</td>
    <td align='right'> {{ test_info.number_fail }}</td>
    <td align='right'> {{ test_info.number_total }}</td>

    {% if test_info.number_passrate == 0 %}
    <td align='right' style="background-color:red" > {{ test_info.number_passrate|floatformat:2 }}</td>
    {% elif test_info.number_passrate == 100 %}
    <td align='right' style="background-color:green" > {{ test_info.number_passrate|floatformat:2 }}</td>
    {% else %}
    <td align='right'> {{ test_info.number_passrate|floatformat:2 }}</td>
    {% endif %}
    {% with test_info.failed_testcases as failed_testcases %}
        {% ifequal test_info.number_total 0 %}
            <td> -- </td>
        {% else %}
            <td>
                {% for test_case in failed_testcases %}
                {{ test_case.name }} <br/>
                {% endfor %}
            </td>
        {% endifequal %}
    {% endwith%}
    <td align='left'>
        {% with test_info.bugs as bugs %}
        {% for bug in bugs %}
            {% if not bug.build_no or bug.build_no == build_info.build_no %}
            <a target='_blank' href="{{ bug.link }}">{{ bug.bug_id }} </a><br/>
            {% endif %}
        {% endfor%}
        {% endwith%}
    </td>
    <td align='left'>
        <a target='_blank' href="/report/add-bug/?build_name={{ build_info.build_name }}&plan_suite={{ test_info.job_name }}&&module_testcase={{ test_info.job_name }}">Add Bug</a><br/>
        {% ifequal test_info.number_passrate 0 %}
        <a target='_blank' href="{{ build_info.new_bug_url_prefix }}{{ test_info.job_name }}">Report Android Bug</a>&nbsp;
        <!--
        <a target='_blank' href="https://bugs.linaro.org/enter_bug.cgi?product=LAVA%20Framework">Report LAVA Bug</a>&nbsp;
        -->
        {% endifequal %}
    </td>
</tr>
{% endfor %}
</table>
{% else %}
No result for vts test jobs.
{% endif %}
<hr/>

<h2>Bug Status:</h2>
{% if build_bugs %}
<table border=2>
<tr>
    <th>Index</th>
    <th>Bug Id</th>
    <th>Plan/TestSuite</th>
    <th>Module/TestCase</th>
    <th>Subject</th>
    <th>Status</th>
    <th>Comments</th>
</tr>
{% for bug in build_bugs %}
{% if not bug.build_no or bug.build_no == build_info.build_no %}
<tr>
    <td>{{ forloop.counter }}</a></td>
    <td><a href="{{ bug.link }}">{{ bug.bug_id }}</a></td>
    <td>{{ bug.plan_suite }}</a></td>
    <td>{{ bug.module_testcase }}</a></td>
    <td>{{ bug.subject }}</a></td>
    <td>{{ bug.status }}</a></td>
    <td> -- </a></td>
</tr>
{% endif %}
{% endfor %}
</table>
{% else %}
Excelent build, no open bugs on it at the moment.
{% endif %}

</div>
{% endblock %}
